<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>In Love üíñ</title>
  <!-- Favicon tr√°i tim -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><text y='50' font-size='52'>üíñ</text></svg>">
  <style>
    :root{ --pink:#e75480; }
    body{
      margin:0; background:#fff; overflow:hidden;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      height:100vh; gap:12px; cursor: crosshair;
    }
    .center-text, .counter{ position: relative; z-index: 20; user-select:none; color: var(--pink); text-align:center; }
    .center-text{ font-size:2.5rem; font-weight:500; }
    .counter{ font-size:1.5rem; font-weight:400; }

    .heart, .icon-burst{ position: fixed; left:0; top:0; transform: translate(-50%, -50%); pointer-events:none; will-change: transform, opacity; z-index: 5; }
    .heart svg{ display:block; filter: drop-shadow(0 2px 6px rgba(0,0,0,.2)); }
    .icon-burst{ font-size:32px; }

    .music-wrap{position: fixed; right:14px; top:14px; z-index:30; display:flex; flex-direction:column; align-items:flex-end; gap:6px}
    .music-btn{ background:#fff; color:#111; border:1px solid rgba(0,0,0,.1); border-radius:999px; padding:8px 12px; font-weight:600; font-size:14px; box-shadow:0 6px 20px rgba(0,0,0,.06); cursor:pointer; user-select:none; }
    .music-title{ background:rgba(255,230,238,.9); color:#d9487e; border:1px solid rgba(217,72,126,.18); padding:6px 10px; border-radius:999px; font-size:12px; font-weight:700; box-shadow:0 6px 18px rgba(217,72,126,.12); max-width:240px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
  </style>
</head>
<body>
  <div class="music-wrap">
    <button class="music-btn" id="musicBtn" aria-pressed="false">üéµ B·∫≠t nh·∫°c</button>
    <div class="music-title" id="musicTitle" aria-live="polite" hidden>(ch∆∞a ph√°t)</div>
  </div>

  <div class="center-text" id="mainText">H·ªØu H∆∞ng ‚ù§Ô∏è Thu√Ω B√¨nh</div>
  <div class="counter" id="dayCounter">ƒê√£ b√™n nhau 0 ng√†y</div>

  <audio id="bgm" preload="auto" playsinline></audio>

  <div id="stage"></div>

  <template id="heartTpl">
    <div class="heart" aria-hidden="true">
      <svg viewBox="0 0 32 29" width="32" height="32">
        <path d="M23.6 0c-3 0-5.6 1.6-7.6 4C14 1.6 11.4 0 8.4 0 3.8 0 0 3.7 0 8.3c0 9.2 16 20.4 16 20.4S32 17.5 32 8.3C32 3.7 28.2 0 23.6 0z" fill="currentColor"/>
      </svg>
    </div>
  </template>

  <script>
  'use strict';
  // ===== Elements =====
  const stage = document.getElementById('stage');
  const tpl = document.getElementById('heartTpl');
  const counterEl = document.getElementById('dayCounter');
  const audio = document.getElementById('bgm');
  const musicBtn = document.getElementById('musicBtn');
  const musicTitleEl = document.getElementById('musicTitle');

  // ===== Playlist hardcode =====
  const PLAYLIST = [
    'iloveyou3000.mp3',
    'youngandbeautiful.mp3',
    'Mirrors.mp3'
  ];
  let currentIndex = 0;
  let kicked = false;
  let ready = false; // ƒë√£ ƒë·ªß buffer ƒë·ªÉ ph√°t m∆∞·ª£t ch∆∞a?

  function niceTitle(src){
    try{
      const url = new URL(src, window.location.href);
      const name = decodeURIComponent(url.pathname.split('/').pop() || '');
      return name.replace(/\.[^/.]+$/, '').replace(/[-_]+/g,' ').trim();
    }catch{ return src; }
  }

  function primeFirstTrack(){
    if(!PLAYLIST.length) return;
    const firstSrc = new URL(PLAYLIST[currentIndex], window.location.href).href;
    audio.preload = 'auto';
    audio.src = firstSrc;
    audio.setAttribute('playsinline','');
    musicTitleEl.textContent = niceTitle(firstSrc);
    try{ audio.load(); }catch(_){}
  }

  // ƒë√°nh d·∫•u ready khi ƒë·ªß buffer
  audio.addEventListener('canplaythrough', ()=>{ ready = true; });
  audio.addEventListener('loadeddata', ()=>{ /* ƒë√¥i khi canplaythrough kh√¥ng b·∫Øn tr√™n iOS */ ready = ready || audio.readyState >= 2; });
  // n·∫øu b·ªã stall/l·ªói, th·ª≠ n·∫°p l·∫°i v√† ph√°t ti·∫øp
  ['stalled','error','abort','emptied'].forEach(ev=>{
    audio.addEventListener(ev, ()=>{
      try{ const s = audio.src; audio.pause(); audio.src = s; audio.load(); if(!audio.paused) audio.play().catch(()=>{}); }catch(e){}
    });
  });

  function nextTrack(){
    if(!PLAYLIST.length) return;
    currentIndex = (currentIndex + 1) % PLAYLIST.length;
    audio.src = PLAYLIST[currentIndex];
    musicTitleEl.textContent = niceTitle(PLAYLIST[currentIndex]);
    audio.play().catch(()=>{});
  }
  audio.addEventListener('ended', nextTrack);

  // First user interaction ‚Üí play ASAP
  const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
  async function safePlayWithRetry(attempts = 3){
    for(let i=0;i<attempts;i++){
      try{ audio.muted = false; await audio.play(); return true; }catch(e){ await sleep(200*(i+1)); }
    }
    // l·∫ßn cu·ªëi: reset src r·ªìi th·ª≠ 1 l·∫ßn n·ªØa
    try{ const s = audio.src; audio.src = s; audio.load(); await audio.play(); return true; }catch(e){ return false; }
  }

  const firstKick = async ()=>{
    if(kicked) return; kicked = true;
    // n·∫øu ch∆∞a g√°n b√†i ƒë·∫ßu ti√™n v√¨ l√Ω do n√†o ƒë√≥, g·∫Øn l·∫°i
    if(!audio.src) primeFirstTrack();
    const ok = await safePlayWithRetry(3);
    if(ok){
      musicBtn.textContent = 'üéµ ƒêang ph√°t';
      musicBtn.setAttribute('aria-pressed','true');
      musicTitleEl.hidden = false;
    }else{ kicked = false; }
    window.removeEventListener('pointerdown', firstKick);
    window.removeEventListener('keydown', firstKick);
    window.removeEventListener('touchstart', firstKick);
  };

  musicBtn.addEventListener('click', async ()=>{
    if(audio.paused){ await firstKick(); }
    else{ audio.pause(); musicBtn.textContent = 'üéµ B·∫≠t nh·∫°c'; musicBtn.setAttribute('aria-pressed','false'); }
  });

  window.addEventListener('pointerdown', firstKick, { once:true });
  window.addEventListener('keydown', firstKick, { once:true });
  window.addEventListener('touchstart', firstKick, { once:true });

  // ===== Hearts auto float =====
  function rand(min, max){ return Math.random() * (max - min) + min; }

  function createHeart(x, y, color){
    const node = tpl.content.firstElementChild.cloneNode(true);
    const size = rand(16, 40);
    node.style.width = node.style.height = size + 'px';
    node.style.color = color || `hsl(${(rand(330, 380)) % 360} ${rand(70,95)}% ${rand(55,75)}%)`;

    const sway = rand(30, 120);
    const drift = rand(-sway, sway);
    const duration = rand(6, 12);
    const start = performance.now();
    const angle = rand(0, Math.PI*2);
    const rot = rand(-30, 30);
    const startX = x + drift;
    const startY = y;

    function frame(t){
      const k = (t - start) / (duration * 1000);
      if(k >= 1){ node.remove(); return; }
      const ease = 1 - Math.pow(1 - k, 2);
      const up = ease * (window.innerHeight * 0.9 + 100);
      const swayX = Math.sin(k * Math.PI * 2 + angle) * sway * (1 - k);
      node.style.transform = `translate(${startX + swayX}px, ${startY - up}px) rotate(${rot * (1-k)}deg)`;
      node.style.opacity = 1 - k;
      requestAnimationFrame(frame);
    }
    node.style.left = '0'; node.style.top = '0';
    stage.appendChild(node);
    requestAnimationFrame(frame);
  }

  function loop(t){
    const freq = 220;
    if(!window.lastSpawn || t - window.lastSpawn > freq){
      window.lastSpawn = t;
      const x = rand(0, window.innerWidth);
      const y = window.innerHeight + 20;
      createHeart(x, y);
    }
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  // ===== Click burst ü¶äüê∞ =====
  const ICONS = ['ü¶ä','üê∞','‚òÅÔ∏è','üåü','üå∏'];
  function createIcon(x, y){
    const el = document.createElement('div');
    el.className = 'icon-burst';
    el.textContent = ICONS[Math.floor(Math.random() * ICONS.length)];
    el.style.fontSize = rand(28, 42) + 'px';

    const duration = rand(0.9, 1.6);
    const start = performance.now();
    const angle = rand(-Math.PI/2 - 0.7, -Math.PI/2 + 0.7);
    const speed = rand(220, 420);
    const gravity = 620;
    const spin = rand(-40, 40);
    const vx = Math.cos(angle) * speed;
    const vy = Math.sin(angle) * speed;

    function frame(t){
      const k = (t - start) / 1000;
      if(k >= duration){ el.remove(); return; }
      const dx = vx * k;
      const dy = vy * k + 0.5 * gravity * k * k;
      el.style.transform = `translate(${x + dx}px, ${y + dy}px) rotate(${spin * k}deg)`;
      el.style.opacity = 1 - (k / duration);
      requestAnimationFrame(frame);
    }
    el.style.left = '0'; el.style.top = '0';
    stage.appendChild(el);
    requestAnimationFrame(frame);
  }

  function burstAt(x, y, count = 12){
    for(let i=0;i<count;i++){
      const jitterX = rand(-25, 25);
      const jitterY = rand(-15, 15);
      createIcon(x + jitterX, y + jitterY);
    }
  }

  let holding = false, holdTimer;
  window.addEventListener('pointerdown', (e)=>{
    holding = true; burstAt(e.clientX, e.clientY, 12);
    clearInterval(holdTimer);
    holdTimer = setInterval(()=>{ if(holding) burstAt(e.clientX, e.clientY, 8); }, 200);
  });
  window.addEventListener('pointerup', ()=>{ holding = false; clearInterval(holdTimer); });

  // ===== Day counter (from 2025-03-20) =====
  const startDate = new Date('2025-03-20T00:00:00');
  function updateCounter(){
    const now = new Date();
    const diff = now - startDate;
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
    const minutes = Math.floor((diff / (1000 * 60)) % 60);
    const seconds = Math.floor((diff / 1000) % 60);
    counterEl.textContent = `We were together ${days} day ${hours} hour ${minutes} min ${seconds} second`;
  }
  updateCounter();
  setInterval(updateCounter, 1000);

  // Prime audio on load so click ph√°t nhanh
  document.addEventListener('DOMContentLoaded', primeFirstTrack);
  </script>
</body>
</html>
